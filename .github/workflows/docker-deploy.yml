name: Build and Deploy Docker Image

on:
  push:
    branches:
      - main # Déclenche l'action sur un push vers la branche main

jobs:
  build:
    runs-on: ubuntu-latest # Utilise Ubuntu comme environnement de build

    steps:
      - name: Checkout code
        uses: actions/checkout@v2 # Vérifie le code source du repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1 # Prépare l'environnement Docker pour la construction

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io # Registre GitHub Container Registry
          username: tomshr29 # Ton nom d'utilisateur GitHub
          password: ${{ secrets.TOKEN_TOK }} # Token GitHub pour l'authentification

      - name: Build the Docker image
        run: |
          docker build -t ghcr.io/tomshr29/t29:latest .  # Construction de l'image Docker

      - name: Push the Docker image to GitHub Container Registry
        run: |
          docker push ghcr.io/tomshr29/t29:latest  # Pousse l'image construite sur le registre

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.6 # Action pour déployer sur le serveur via SSH
        with:
          host: ${{ secrets.SERVER_IP }} # L'IP de ton serveur
          username: root # L'utilisateur pour SSH (ex: root)
          key: ${{ secrets.SERVER_SSH_KEY }} # La clé privée SSH stockée dans les secrets GitHub
          script: |
            # Installer Docker Compose sur le serveur (si nécessaire)
            if ! command -v docker-compose &> /dev/null
            then
                echo "Docker Compose could not be found. Installing..."
                curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                chmod +x /usr/local/bin/docker-compose
            fi

            # Pull la dernière image Docker
            docker pull ghcr.io/tomshr29/t29:latest

            # Arrêter les conteneurs en cours
            docker-compose down

            # Rebuild et redémarre les conteneurs
            docker-compose up -d --build
